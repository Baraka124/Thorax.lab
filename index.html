<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>ThoraxLab | Clinical-Industry Innovation Platform</title>
    
    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    
    <style>
        /* ===== CRITICAL CSS ===== */
        :root {
            /* Design Tokens */
            --clinical-blue: #1A56DB;
            --clinical-light: #3B82F6;
            --industry-teal: #0E9F6E;
            --industry-light: #14B8A6;
            --accent-purple: #7E3AF2;
            --accent-pink: #DB2777;
            --success-green: #10B981;
            --warning-orange: #F59E0B;
            --error-red: #EF4444;
            --gray-50: #F9FAFB;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-300: #D1D5DB;
            --gray-400: #9CA3AF;
            --gray-500: #6B7280;
            --gray-600: #4B5563;
            --gray-700: #374151;
            --gray-800: #1F2937;
            --gray-900: #111827;
            
            /* Layout */
            --max-width: 1440px;
            --header-height: 64px;
            --touch-min: 44px;
            
            /* Typography */
            --type-ratio: 1.25;
            --text-xs: 0.75rem;
            --text-sm: 0.875rem;
            --text-base: 1rem;
            --text-lg: 1.125rem;
            --text-xl: 1.25rem;
            --text-2xl: 1.5rem;
            --text-3xl: 1.875rem;
            --text-4xl: 2.25rem;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #FFFFFF;
            color: #111827;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ===== UTILITY CLASSES ===== */
        .hidden { display: none !important; }
        .sr-only { 
            position: absolute; 
            width: 1px; 
            height: 1px; 
            padding: 0; 
            margin: -1px; 
            overflow: hidden; 
            clip: rect(0,0,0,0); 
            white-space: nowrap; 
            border: 0; 
        }

        /* ===== AUTH SCREEN ===== */
        .auth-screen {
            min-height: 100vh;
            display: grid;
            place-items: center;
            padding: 2rem;
            background: linear-gradient(135deg, #F0F9FF 0%, #ECFDF5 100%);
        }

        .auth-card {
            width: 100%;
            max-width: 440px;
            background: white;
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        /* ===== MAIN LAYOUT ===== */
        #mainApp {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .app-header {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid #E5E7EB;
            height: var(--header-height);
        }

        /* ===== MOBILE NAVIGATION ===== */
        @media (max-width: 767px) {
            .mobile-bottom-nav {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: white;
                border-top: 1px solid #E5E7EB;
                display: flex;
                justify-content: space-around;
                padding: 0.5rem;
                z-index: 1000;
            }
            
            .desktop-nav {
                display: none;
            }
        }

        @media (min-width: 768px) {
            .mobile-bottom-nav {
                display: none;
            }
        }

        /* ===== ANIMATIONS ===== */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ===== SKELETON LOADING ===== */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 8px;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Toast Container -->
        <div id="toastContainer" class="toast-container"></div>
        
        <!-- Undo Action Toast -->
        <div id="undoToast" class="undo-toast hidden">
            <div class="undo-content">
                <span id="undoMessage"></span>
                <button id="undoActionBtn" class="btn-undo">Undo</button>
                <button id="dismissUndoBtn" class="btn-dismiss">&times;</button>
            </div>
        </div>
        
        <!-- Keyboard Shortcuts Helper -->
        <div id="keyboardShortcuts" class="keyboard-shortcuts hidden">
            <div class="shortcuts-modal">
                <h3><i class="fas fa-keyboard"></i> Keyboard Shortcuts</h3>
                <div class="shortcuts-grid">
                    <div><kbd>Ctrl</kbd> + <kbd>N</kbd> <span>New Project</span></div>
                    <div><kbd>Ctrl</kbd> + <kbd>D</kbd> <span>New Discussion</span></div>
                    <div><kbd>/</kbd> <span>Search</span></div>
                    <div><kbd>Escape</kbd> <span>Close Modals</span></div>
                    <div><kbd>?</kbd> <span>Show Help</span></div>
                </div>
            </div>
        </div>
        
        <!-- Loading Overlay -->
        <div id="globalLoading" class="global-loading hidden">
            <div class="loading-content">
                <div class="loading-spinner"></div>
                <div class="loading-text">Loading...</div>
            </div>
        </div>
        
        <!-- Authentication Screen -->
        <div id="authScreen" class="auth-screen">
            <div class="auth-card">
                <div class="auth-header">
                    <div class="brand-logo">
                        <i class="fas fa-handshake"></i>
                        <span>ThoraxLab</span>
                    </div>
                    <p class="brand-subtitle">Clinical-Industry Innovation Collaboration Platform</p>
                </div>
                
                <div class="auth-body">
                    <div class="auth-avatar">
                        <i class="fas fa-user-md"></i>
                    </div>
                    
                    <h2>Welcome to ThoraxLab</h2>
                    <p class="auth-subtitle">Collaborate. Innovate. Transform Healthcare.</p>
                    
                    <form id="authForm" class="auth-form">
                        <div class="form-group">
                            <label for="username">Username</label>
                            <input type="text" id="username" required 
                                   placeholder="Enter your username">
                            <small class="form-hint">Use "admin" for admin or "pneumo2025-2026" for doctors</small>
                        </div>
                        
                        <div class="form-group">
                            <div class="password-header">
                                <label for="password">Password</label>
                                <button type="button" id="passwordToggle" class="btn-text">Show</button>
                            </div>
                            <div class="password-wrapper">
                                <input type="password" id="password" required 
                                       placeholder="Enter your password">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="userType">Login As</label>
                            <select id="userType" required>
                                <option value="">Select user type</option>
                                <option value="clinical">Clinical Professional</option>
                                <option value="industry">Industry Professional</option>
                                <option value="guest">Guest Contributor</option>
                                <option value="admin">Administrator</option>
                            </select>
                        </div>
                        
                        <button type="submit" id="loginBtn" class="btn btn-primary btn-block">
                            <i class="fas fa-sign-in-alt"></i>
                            Sign In to Platform
                        </button>
                        
                        <div class="auth-footer">
                            <p><i class="fas fa-info-circle"></i> Doctors: Use "pneumo2025-2026" for both username and password</p>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Main Application -->
        <div id="mainApp" class="hidden">
            <!-- Desktop Header -->
            <header class="app-header desktop-nav">
                <div class="header-container">
                    <button id="mobileMenuToggle" class="mobile-menu-toggle" aria-label="Toggle menu">
                        <i class="fas fa-bars"></i>
                    </button>
                    
                    <a href="#dashboard" class="brand">
                        <i class="fas fa-handshake"></i>
                        <span>ThoraxLab</span>
                    </a>
                    
                    <nav class="main-nav" id="mainNav">
                        <a href="#dashboard" class="nav-link active" data-page="dashboard">
                            <i class="fas fa-chart-line"></i>
                            <span>Dashboard</span>
                        </a>
                        <a href="#projects" class="nav-link" data-page="projects">
                            <i class="fas fa-project-diagram"></i>
                            <span>All Projects</span>
                        </a>
                        <a href="#myprojects" class="nav-link" data-page="myprojects">
                            <i class="fas fa-folder"></i>
                            <span>My Projects</span>
                        </a>
                        <a href="#discussions" class="nav-link" data-page="discussions">
                            <i class="fas fa-comments"></i>
                            <span>Discussions</span>
                            <span id="unreadBadge" class="notification-badge hidden">0</span>
                        </a>
                        <a href="#fromtraci" class="nav-link" data-page="fromtraci">
                            <i class="fas fa-hospital"></i>
                            <span>From TRAci</span>
                        </a>
                        <a href="#admin" class="nav-link admin-only" data-page="admin">
                            <i class="fas fa-shield-alt"></i>
                            <span>Admin</span>
                        </a>
                    </nav>
                    
                    <div class="header-actions">
                        <div class="search-container">
                            <button class="search-toggle" aria-label="Search">
                                <i class="fas fa-search"></i>
                            </button>
                            <div class="search-dropdown hidden">
                                <input type="search" id="globalSearch" 
                                       placeholder="Search projects, discussions, users..." 
                                       aria-label="Search platform">
                                <div class="search-results" id="searchResults"></div>
                            </div>
                        </div>
                        
                        <button id="notificationsToggle" class="notifications-toggle" aria-label="Notifications">
                            <i class="fas fa-bell"></i>
                            <span id="notificationCount" class="notification-badge hidden">0</span>
                        </button>
                        
                        <div class="user-menu">
                            <button id="userMenuToggle" class="user-avatar" aria-label="User menu">
                                <span id="userInitials">?</span>
                            </button>
                            <div id="userDropdown" class="dropdown-menu hidden">
                                <div class="dropdown-header">
                                    <div id="dropdownUserName">Loading...</div>
                                    <div id="dropdownUserRole" class="user-role">Loading...</div>
                                </div>
                                <a href="#profile" class="dropdown-item" data-page="profile">
                                    <i class="fas fa-user"></i> My Profile
                                </a>
                                <a href="#settings" class="dropdown-item">
                                    <i class="fas fa-cog"></i> Settings
                                </a>
                                <div class="dropdown-divider"></div>
                                <button class="dropdown-item" onclick="window.thoraxLab.logout()">
                                    <i class="fas fa-sign-out-alt"></i> Sign Out
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </header>
            
            <!-- Mobile Bottom Navigation -->
            <nav class="mobile-bottom-nav">
                <a href="#dashboard" class="nav-item active">
                    <i class="fas fa-home"></i>
                    <span>Home</span>
                </a>
                <a href="#projects" class="nav-item">
                    <i class="fas fa-project-diagram"></i>
                    <span>Projects</span>
                </a>
                <a href="#discussions" class="nav-item">
                    <i class="fas fa-comments"></i>
                    <span>Discussions</span>
                </a>
                <a href="#myprojects" class="nav-item">
                    <i class="fas fa-user"></i>
                    <span>My Work</span>
                </a>
                <button class="nav-item" onclick="window.thoraxLab.showQuickActions()">
                    <i class="fas fa-plus"></i>
                    <span>Create</span>
                </button>
            </nav>
            
            <!-- Main Content -->
            <main class="main-content">
                <!-- Pages will be dynamically rendered -->
            </main>
            
            <!-- Quick Actions Menu -->
            <div id="quickActionsMenu" class="quick-actions-menu hidden">
                <button class="quick-action" data-action="new-project">
                    <i class="fas fa-project-diagram"></i>
                    <span>New Project</span>
                </button>
                <button class="quick-action" data-action="new-discussion">
                    <i class="fas fa-comments"></i>
                    <span>New Discussion</span>
                </button>
                <button class="quick-action" data-action="import-traci">
                    <i class="fas fa-download"></i>
                    <span>Import to TRAci</span>
                </button>
            </div>
        </div>
        
        <!-- All Modals will be dynamically created -->
    </div>

<script>
// ============================================
// COMPLETE THORAXLAB IMPLEMENTATION
// ============================================

class ThoraxLab {
    constructor() {
        // Supabase Configuration
        this.SUPABASE_URL = 'https://bledpouekiytppuhxeqq.supabase.co';
        this.SUPABASE_ANON_KEY = 'sb_publishable_zdlIM8UbOrRIFpmYLJOmWQ_4QqNi_5C';
        this.supabase = null;
        
        // Application State
        this.state = {
            currentUser: null,
            isAdmin: false,
            currentPage: 'dashboard',
            pages: {
                dashboard: this.createDashboardPage(),
                projects: this.createProjectsPage(),
                myprojects: this.createMyProjectsPage(),
                discussions: this.createDiscussionsPage(),
                fromtraci: this.createTraciPage(),
                admin: this.createAdminPage(),
                profile: this.createProfilePage()
            },
            modals: {},
            activeFilters: {},
            searchQuery: '',
            selectedProjects: new Set(),
            notifications: [],
            undoStack: [],
            savedSearches: this.loadSavedSearches(),
            userPreferences: this.loadUserPreferences()
        };
        
        // Data Cache
        this.cache = {
            projects: [],
            discussions: [],
            profiles: new Map(),
            stats: {},
            lastUpdated: {}
        };
        
        // Real-time Channels
        this.channels = {
            projects: null,
            discussions: null,
            comments: null
        };
        
        // Keyboard Shortcuts
        this.shortcuts = new Map([
            ['ctrl+n', () => this.showNewProjectModal()],
            ['ctrl+d', () => this.showNewDiscussionModal()],
            ['/', (e) => { e.preventDefault(); this.focusSearch(); }],
            ['escape', () => this.hideAllModals()],
            ['?', () => this.showKeyboardHelp()]
        ]);
        
        // Performance Monitoring
        this.performance = {
            startTime: Date.now(),
            metrics: []
        };
        
        this.init();
    }
    
    // ============================================
    // INITIALIZATION
    // ============================================
    
    async init() {
        console.log('ðŸš€ Initializing ThoraxLab...');
        
        try {
            // Initialize Supabase
            this.supabase = window.supabase.createClient(
                this.SUPABASE_URL, 
                this.SUPABASE_ANON_KEY
            );
            
            // Setup Event Listeners
            this.setupEventListeners();
            
            // Setup Router
            this.setupRouter();
            
            // Check for Saved Session
            await this.checkSavedSession();
            
            console.log('âœ… ThoraxLab initialized successfully');
        } catch (error) {
            console.error('âŒ Initialization failed:', error);
            this.showError('Failed to initialize application');
        }
    }
    
    setupEventListeners() {
        // Auth Form
        document.getElementById('authForm')?.addEventListener('submit', 
            (e) => this.handleLogin(e)
        );
        
        // Password Toggle
        document.getElementById('passwordToggle')?.addEventListener('click', 
            () => this.togglePasswordVisibility()
        );
        
        // Mobile Menu
        document.getElementById('mobileMenuToggle')?.addEventListener('click',
            () => this.toggleMobileMenu()
        );
        
        // Keyboard Shortcuts
        document.addEventListener('keydown', (e) => this.handleKeyboardShortcut(e));
        
        // Window Events
        window.addEventListener('hashchange', () => this.handleRoute());
        window.addEventListener('resize', () => this.handleResize());
        
        // Click Outside Handlers
        document.addEventListener('click', (e) => this.handleClickOutside(e));
        
        console.log('âœ… Event listeners setup complete');
    }
    
    setupRouter() {
        // Initial route handling
        this.handleRoute();
    }
    
    // ============================================
    // AUTHENTICATION SYSTEM
    // ============================================
    
    async checkSavedSession() {
        try {
            const savedUser = localStorage.getItem('thoraxlab_user');
            const savedSession = localStorage.getItem('thoraxlab_session');
            
            if (savedUser && savedSession) {
                const user = JSON.parse(savedUser);
                
                // Verify session with backend
                const { data: profile, error } = await this.supabase
                    .from('thoraxlab_profiles')
                    .select('*')
                    .eq('user_id', user.id)
                    .single();
                
                if (error || !profile) {
                    throw new Error('Session expired');
                }
                
                this.state.currentUser = { ...user, ...profile };
                this.state.isAdmin = this.state.currentUser.user_type === 'admin';
                
                this.showApplication();
                await this.loadInitialData();
                await this.setupRealtimeSubscriptions();
                
                // Navigate to saved page or dashboard
                const hash = window.location.hash.substring(1) || 'dashboard';
                this.navigateTo(hash);
                
                this.showToast(`Welcome back, ${this.state.currentUser.full_name}!`, 'success');
            } else {
                this.showAuthScreen();
            }
        } catch (error) {
            console.log('Session check failed:', error);
            this.clearSession();
            this.showAuthScreen();
        }
    }
    
    async handleLogin(e) {
        e.preventDefault();
        
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value.trim();
        const userType = document.getElementById('userType').value;
        
        // Validation
        if (!username || !password || !userType) {
            this.showToast('Please fill in all fields', 'error');
            return;
        }
        
        // Show loading
        const loginBtn = document.getElementById('loginBtn');
        const originalText = loginBtn.innerHTML;
        loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Signing in...';
        loginBtn.disabled = true;
        
        try {
            let userData;
            
            // Check if user exists
            const { data: existingUser, error: fetchError } = await this.supabase
                .from('thoraxlab_profiles')
                .select('*')
                .eq('full_name', username)
                .eq('user_type', userType)
                .maybeSingle();
            
            if (fetchError && fetchError.code !== 'PGRST116') throw fetchError;
            
            if (existingUser) {
                // Existing user - verify password
                if (existingUser.password_hash !== password) {
                    throw new Error('Invalid password');
                }
                userData = existingUser;
            } else {
                // Create new user
                const userId = this.generateUUID();
                
                userData = {
                    user_id: userId,
                    full_name: username,
                    user_type: userType,
                    password_hash: password,
                    is_verified: userType === 'admin' || userType === 'clinical',
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                
                // Add role-specific fields
                if (userType === 'clinical') {
                    userData.clinical_specialty = 'Pulmonology';
                    userData.hospital_institution = 'General Hospital';
                    userData.expertise = ['COPD', 'Respiratory Medicine'];
                } else if (userType === 'industry') {
                    userData.professional_role = 'Industry Professional';
                    userData.company = 'Technology Company';
                    userData.expertise = ['Medical Devices', 'Digital Health'];
                } else if (userType === 'admin') {
                    userData.is_verified = true;
                    userData.expertise = ['Platform Management', 'User Administration'];
                } else {
                    userData.expertise = ['General'];
                }
                
                const { data: newUser, error: createError } = await this.supabase
                    .from('thoraxlab_profiles')
                    .insert([userData])
                    .select()
                    .single();
                
                if (createError) throw createError;
                userData = newUser;
            }
            
            // Set current user
            this.state.currentUser = {
                id: userData.user_id,
                name: userData.full_name,
                type: userData.user_type,
                avatar: userData.full_name.substring(0, 2).toUpperCase(),
                ...userData
            };
            
            this.state.isAdmin = this.state.currentUser.type === 'admin';
            
            // Save session
            localStorage.setItem('thoraxlab_user', JSON.stringify(this.state.currentUser));
            localStorage.setItem('thoraxlab_session', 'active');
            
            // Show application
            this.showApplication();
            this.updateUserDisplay();
            
            // Load data
            await this.loadInitialData();
            await this.setupRealtimeSubscriptions();
            
            // Navigate to dashboard
            this.navigateTo('dashboard');
            
            this.showToast(`Welcome ${userData.full_name}!`, 'success');
            
        } catch (error) {
            console.error('Login error:', error);
            this.showToast(`Login failed: ${error.message}`, 'error');
        } finally {
            loginBtn.innerHTML = originalText;
            loginBtn.disabled = false;
        }
    }
    
    logout() {
        // Cleanup real-time subscriptions
        this.cleanupRealtimeSubscriptions();
        
        // Clear session
        this.clearSession();
        
        // Show auth screen
        this.showAuthScreen();
        
        this.showToast('You have been logged out', 'info');
    }
    
    clearSession() {
        localStorage.removeItem('thoraxlab_user');
        localStorage.removeItem('thoraxlab_session');
        this.state.currentUser = null;
        this.state.isAdmin = false;
        this.cache = {
            projects: [],
            discussions: [],
            profiles: new Map(),
            stats: {},
            lastUpdated: {}
        };
    }
    
    // ============================================
    // PAGE MANAGEMENT
    // ============================================
    
    createDashboardPage() {
        return {
            render: async () => {
                return `
                    <div class="page" id="dashboardPage">
                        <div class="page-header">
                            <h1 id="welcomeMessage">Innovation Dashboard</h1>
                            <p>Monitor your clinical-industry collaborations</p>
                            <div class="header-actions">
                                <button class="btn btn-primary" onclick="window.thoraxLab.showNewProjectModal()">
                                    <i class="fas fa-plus"></i> New Project
                                </button>
                                <button class="btn btn-secondary" onclick="window.thoraxLab.syncTraciProjects()">
                                    <i class="fas fa-sync-alt"></i> Sync TRAci
                                </button>
                            </div>
                        </div>
                        
                        <div class="dashboard-grid" id="statsGrid"></div>
                        
                        <div class="section">
                            <div class="section-header">
                                <h2>Active Collaborations</h2>
                                <a href="#projects" class="btn btn-secondary">View All</a>
                            </div>
                            <div class="projects-grid" id="activeProjects"></div>
                        </div>
                        
                        <div class="activity-section">
                            <div class="section-header">
                                <h2>Recent Activity</h2>
                                <select class="filter-select" id="activityFilter">
                                    <option value="all">All Activity</option>
                                    <option value="projects">Projects</option>
                                    <option value="discussions">Discussions</option>
                                </select>
                            </div>
                            <div class="activity-feed" id="activityFeed"></div>
                        </div>
                    </div>
                `;
            },
            load: async () => {
                await this.loadDashboardData();
            }
        };
    }
    
    createProjectsPage() {
        return {
            render: async () => {
                return `
                    <div class="page" id="projectsPage">
                        <div class="page-header">
                            <h1>All Innovation Projects</h1>
                            <p>Explore clinical-industry collaborations</p>
                            <div class="header-actions">
                                <button class="btn btn-primary" onclick="window.thoraxLab.showNewProjectModal()">
                                    <i class="fas fa-plus"></i> New Project
                                </button>
                                <button class="btn btn-secondary" onclick="window.thoraxLab.toggleBatchMode()">
                                    <i class="fas fa-layer-group"></i> Batch Mode
                                </button>
                            </div>
                        </div>
                        
                        <div class="filters-container">
                            <div class="search-enhanced">
                                <i class="fas fa-search"></i>
                                <input type="search" id="projectSearch" 
                                       placeholder="Search projects, tags, descriptions...">
                                <button class="btn-advanced-search">
                                    <i class="fas fa-sliders-h"></i>
                                </button>
                            </div>
                            
                            <div class="filters-row">
                                <div class="filter-group">
                                    <select class="filter-select" id="projectTypeFilter">
                                        <option value="all">All Types</option>
                                        <option value="clinical">Clinical-Led</option>
                                        <option value="industry">Industry-Led</option>
                                        <option value="collaboration">Collaboration</option>
                                    </select>
                                    
                                    <select class="filter-select" id="projectStatusFilter">
                                        <option value="all">All Status</option>
                                        <option value="active">Active</option>
                                        <option value="draft">Draft</option>
                                        <option value="archived">Archived</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="batch-operations hidden" id="batchOperations">
                            <div class="batch-info">
                                <span id="selectedCount">0</span> projects selected
                            </div>
                            <div class="batch-actions">
                                <button class="btn btn-sm btn-secondary" onclick="window.thoraxLab.bulkExport()">
                                    <i class="fas fa-download"></i> Export
                                </button>
                                <button class="btn btn-sm btn-warning" onclick="window.thoraxLab.bulkArchive()">
                                    <i class="fas fa-archive"></i> Archive
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="window.thoraxLab.bulkDelete()">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                                <button class="btn btn-sm btn-ghost" onclick="window.thoraxLab.clearSelection()">
                                    <i class="fas fa-times"></i> Clear
                                </button>
                            </div>
                        </div>
                        
                        <div class="projects-view-container">
                            <div id="projectsList" class="projects-grid"></div>
                            <div id="loadingMore" class="loading-more hidden">
                                <div class="loading-spinner"></div>
                                <span>Loading more projects...</span>
                            </div>
                        </div>
                    </div>
                `;
            },
            load: async () => {
                await this.loadAllProjects();
                this.setupProjectFilters();
            }
        };
    }
    
    createDiscussionsPage() {
        return {
            render: async () => {
                return `
                    <div class="page" id="discussionsPage">
                        <div class="page-header">
                            <h1>Discussion Threads</h1>
                            <p>Join conversations and share insights</p>
                            <div class="header-actions">
                                <button class="btn btn-primary" onclick="window.thoraxLab.showNewDiscussionModal()">
                                    <i class="fas fa-plus"></i> New Discussion
                                </button>
                            </div>
                        </div>
                        
                        <div class="discussion-filters">
                            <div class="filter-buttons">
                                <button class="filter-btn active" data-filter="all">All</button>
                                <button class="filter-btn" data-filter="unread">Unread</button>
                                <button class="filter-btn" data-filter="participating">Participating</button>
                            </div>
                            
                            <div class="discussion-search">
                                <i class="fas fa-search"></i>
                                <input type="search" placeholder="Search discussions..." 
                                       id="discussionSearch">
                            </div>
                        </div>
                        
                        <div class="discussions-container">
                            <div id="discussionsList" class="discussions-list"></div>
                        </div>
                    </div>
                `;
            },
            load: async () => {
                await this.loadDiscussions();
                this.setupDiscussionFilters();
            }
        };
    }
    
    createMyProjectsPage() {
        return {
            render: async () => {
                return `
                    <div class="page" id="myProjectsPage">
                        <div class="page-header">
                            <h1>My Projects</h1>
                            <p>Manage your innovation initiatives</p>
                            <div class="header-actions">
                                <button class="btn btn-primary" onclick="window.thoraxLab.showNewProjectModal()">
                                    <i class="fas fa-plus"></i> New Project
                                </button>
                            </div>
                        </div>
                        
                        <div class="templates-section">
                            <h3>Start from Template</h3>
                            <div class="templates-grid">
                                <div class="template-card" onclick="window.thoraxLab.useTemplate('clinical-trial')">
                                    <div class="template-icon">
                                        <i class="fas fa-clipboard-check"></i>
                                    </div>
                                    <h4>Clinical Trial</h4>
                                    <p>Protocol development template</p>
                                </div>
                                <div class="template-card" onclick="window.thoraxLab.useTemplate('device-development')">
                                    <div class="template-icon">
                                        <i class="fas fa-tools"></i>
                                    </div>
                                    <h4>Device Development</h4>
                                    <p>Medical device innovation</p>
                                </div>
                            </div>
                        </div>
                        
                        <div id="myProjects" class="projects-grid"></div>
                    </div>
                `;
            },
            load: async () => {
                await this.loadMyProjects();
            }
        };
    }
    
    createTraciPage() {
        return {
            render: async () => {
                return `
                    <div class="page" id="fromtraciPage">
                        <div class="page-header">
                            <h1>Projects from TRAci</h1>
                            <p>Clinical innovations for industry collaboration</p>
                            <div class="header-actions">
                                <button class="btn btn-primary" onclick="window.thoraxLab.syncTraciProjects()">
                                    <i class="fas fa-sync-alt"></i> Sync TRAci
                                </button>
                            </div>
                        </div>
                        
                        <div id="traciProjects" class="projects-grid"></div>
                    </div>
                `;
            },
            load: async () => {
                await this.loadTraciProjects();
            }
        };
    }
    
    createAdminPage() {
        return {
            render: async () => {
                if (!this.state.isAdmin) {
                    this.navigateTo('dashboard');
                    return '';
                }
                
                return `
                    <div class="page" id="adminPage">
                        <div class="page-header">
                            <h1>Administration Dashboard</h1>
                            <p>Manage platform users, projects, and system settings</p>
                            <div class="header-actions">
                                <button class="btn btn-secondary" onclick="window.thoraxLab.exportData()">
                                    <i class="fas fa-download"></i> Export Data
                                </button>
                                <button class="btn btn-primary" onclick="window.thoraxLab.refreshAdmin()">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                            </div>
                        </div>
                        
                        <div class="admin-stats" id="adminStats"></div>
                        
                        <div class="admin-tabs">
                            <div class="tab-nav">
                                <button class="tab-btn active" data-tab="users">Users</button>
                                <button class="tab-btn" data-tab="projects">Projects</button>
                                <button class="tab-btn" data-tab="discussions">Discussions</button>
                                <button class="tab-btn" data-tab="settings">Settings</button>
                            </div>
                            
                            <div class="tab-content">
                                <div class="tab-pane active" id="usersTab"></div>
                                <div class="tab-pane" id="projectsTab"></div>
                                <div class="tab-pane" id="discussionsTab"></div>
                                <div class="tab-pane" id="settingsTab"></div>
                            </div>
                        </div>
                    </div>
                `;
            },
            load: async () => {
                if (this.state.isAdmin) {
                    await this.loadAdminDashboard();
                }
            }
        };
    }
    
    createProfilePage() {
        return {
            render: async () => {
                return `
                    <div class="page" id="profilePage">
                        <div class="page-header">
                            <h1>My Profile</h1>
                            <p>Manage your personal information and preferences</p>
                            <div class="header-actions">
                                <button class="btn btn-secondary" onclick="window.thoraxLab.editProfile()">
                                    <i class="fas fa-edit"></i> Edit Profile
                                </button>
                            </div>
                        </div>
                        
                        <div class="profile-container">
                            <div class="profile-header">
                                <div class="profile-avatar-large">
                                    ${this.state.currentUser?.avatar || '?'}
                                </div>
                                <div class="profile-info">
                                    <h2 id="profileName">${this.state.currentUser?.full_name || 'Loading...'}</h2>
                                    <p id="profileRole">${this.state.currentUser?.user_type || 'Loading...'}</p>
                                    <p id="profileInstitution">${this.state.currentUser?.hospital_institution || this.state.currentUser?.company || ''}</p>
                                </div>
                            </div>
                            
                            <div class="profile-stats">
                                <div class="stat">
                                    <div class="stat-value" id="profileProjects">0</div>
                                    <div class="stat-label">Projects</div>
                                </div>
                                <div class="stat">
                                    <div class="stat-value" id="profileDiscussions">0</div>
                                    <div class="stat-label">Discussions</div>
                                </div>
                                <div class="stat">
                                    <div class="stat-value" id="profileComments">0</div>
                                    <div class="stat-label">Comments</div>
                                </div>
                            </div>
                            
                            <div class="profile-details">
                                <h3>Details</h3>
                                <div class="detail-item">
                                    <label>Email</label>
                                    <div id="profileEmail">Not provided</div>
                                </div>
                                <div class="detail-item">
                                    <label>Specialty/Role</label>
                                    <div id="profileSpecialty">${this.state.currentUser?.clinical_specialty || this.state.currentUser?.professional_role || 'Not specified'}</div>
                                </div>
                                <div class="detail-item">
                                    <label>Expertise</label>
                                    <div class="expertise-tags" id="profileExpertise"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },
            load: async () => {
                await this.loadProfileData();
            }
        };
    }
    
    // ============================================
    // DATA LOADING METHODS
    // ============================================
    
    async loadInitialData() {
        this.showLoading();
        
        try {
            await Promise.all([
                this.loadProjects(),
                this.loadDiscussions(),
                this.loadProfiles(),
                this.loadStats()
            ]);
            
            // Load notifications
            await this.checkNotifications();
            
            console.log('âœ… Initial data loaded');
        } catch (error) {
            console.error('Error loading initial data:', error);
            this.showToast('Failed to load platform data', 'error');
        } finally {
            this.hideLoading();
        }
    }
    
    async loadProjects() {
        try {
            const { data: projects, error } = await this.supabase
                .from('thoraxlab_projects')
                .select('*')
                .order('created_at', { ascending: false });
            
            if (error) throw error;
            
            this.cache.projects = projects || [];
            return this.cache.projects;
        } catch (error) {
            console.error('Error loading projects:', error);
            this.cache.projects = [];
            return [];
        }
    }
    
    async loadDiscussions() {
        try {
            const { data: discussions, error } = await this.supabase
                .from('thoraxlab_discussions')
                .select('*')
                .order('created_at', { ascending: false });
            
            if (error) throw error;
            
            this.cache.discussions = discussions || [];
            return this.cache.discussions;
        } catch (error) {
            console.error('Error loading discussions:', error);
            this.cache.discussions = [];
            return [];
        }
    }
    
    async loadProfiles() {
        try {
            const { data: profiles, error } = await this.supabase
                .from('thoraxlab_profiles')
                .select('*');
            
            if (error) throw error;
            
            this.cache.profiles.clear();
            (profiles || []).forEach(profile => {
                this.cache.profiles.set(profile.user_id, profile);
            });
            
            return this.cache.profiles;
        } catch (error) {
            console.error('Error loading profiles:', error);
            return new Map();
        }
    }
    
    async loadStats() {
        try {
            const [
                projectsCount,
                discussionsCount,
                usersCount,
                traciCount
            ] = await Promise.all([
                this.supabase.from('thoraxlab_projects').select('id', { count: 'exact', head: true }),
                this.supabase.from('thoraxlab_discussions').select('id', { count: 'exact', head: true }),
                this.supabase.from('thoraxlab_profiles').select('id', { count: 'exact', head: true }),
                this.supabase.from('thoraxlab_projects').select('id', { count: 'exact', head: true })
                    .not('source_traci_project_id', 'is', null)
            ]);
            
            this.cache.stats = {
                totalProjects: projectsCount.count || 0,
                totalDiscussions: discussionsCount.count || 0,
                totalUsers: usersCount.count || 0,
                traciProjects: traciCount.count || 0
            };
            
            return this.cache.stats;
        } catch (error) {
            console.error('Error loading stats:', error);
            return this.cache.stats;
        }
    }
    
    // ============================================
    // PAGE-SPECIFIC DATA LOADING
    // ============================================
    
    async loadDashboardData() {
        // Load stats
        const stats = await this.loadStats();
        
        // Render stats grid
        const statsGrid = document.getElementById('statsGrid');
        if (statsGrid) {
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-project-diagram"></i>
                    </div>
                    <div class="stat-value">${stats.totalProjects}</div>
                    <div class="stat-label">Total Projects</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-comments"></i>
                    </div>
                    <div class="stat-value">${stats.totalDiscussions}</div>
                    <div class="stat-label">Active Discussions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-value">${stats.totalUsers}</div>
                    <div class="stat-label">Platform Members</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-hospital"></i>
                    </div>
                    <div class="stat-value">${stats.traciProjects}</div>
                    <div class="stat-label">From TRAci</div>
                </div>
            `;
        }
        
        // Load active projects
        const activeProjects = this.cache.projects
            .filter(p => p.status === 'active')
            .slice(0, 6);
        
        const activeProjectsEl = document.getElementById('activeProjects');
        if (activeProjectsEl) {
            await this.renderProjects(activeProjects, activeProjectsEl);
        }
        
        // Load activity feed
        await this.loadActivityFeed();
    }
    
    async loadAllProjects() {
        const projectsList = document.getElementById('projectsList');
        if (!projectsList) return;
        
        this.showLoading();
        
        try {
            let projects = this.cache.projects;
            
            // Apply filters
            projects = this.applyFilters(projects);
            
            // Apply search
            if (this.state.searchQuery) {
                projects = this.searchProjects(projects, this.state.searchQuery);
            }
            
            await this.renderProjects(projects, projectsList);
        } catch (error) {
            console.error('Error loading projects:', error);
            projectsList.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>Failed to load projects</h3>
                    <p>Please try again later</p>
                </div>
            `;
        } finally {
            this.hideLoading();
        }
    }
    
    async loadMyProjects() {
        if (!this.state.currentUser) return;
        
        const myProjectsEl = document.getElementById('myProjects');
        if (!myProjectsEl) return;
        
        const myProjects = this.cache.projects.filter(
            p => p.owner_id === this.state.currentUser.id
        );
        
        await this.renderProjects(myProjects, myProjectsEl);
    }
    
    async loadTraciProjects() {
        const traciProjectsEl = document.getElementById('traciProjects');
        if (!traciProjectsEl) return;
        
        const traciProjects = this.cache.projects.filter(
            p => p.source_traci_project_id
        );
        
        await this.renderProjects(traciProjects, traciProjectsEl);
    }
    
    async loadDiscussionsPage() {
        const discussionsList = document.getElementById('discussionsList');
        if (!discussionsList) return;
        
        await this.renderDiscussions(this.cache.discussions, discussionsList);
    }
    
    // ============================================
    // RENDERING METHODS
    // ============================================
    
    async renderProjects(projects, container) {
        if (!container) return;
        
        if (!projects || projects.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-project-diagram"></i>
                    <h3>No projects found</h3>
                    <p>Be the first to create a project</p>
                    <button class="btn btn-primary" onclick="window.thoraxLab.showNewProjectModal()">
                        Create Project
                    </button>
                </div>
            `;
            return;
        }
        
        const html = projects.map(project => this.renderProjectCard(project)).join('');
        container.innerHTML = html;
        
        // Add event listeners
        container.querySelectorAll('.project-card').forEach(card => {
            card.addEventListener('click', (e) => {
                if (!e.target.closest('.project-action')) {
                    this.showProjectDetails(project);
                }
            });
        });
    }
    
    renderProjectCard(project) {
        const owner = this.cache.profiles.get(project.owner_id) || {};
        const isFromTraci = !!project.source_traci_project_id;
        
        return `
            <div class="project-card" data-project-id="${project.id}">
                <div class="project-header">
                    <div class="project-badges">
                        <span class="badge badge-${project.project_type}">
                            ${project.project_type}
                        </span>
                        <span class="badge badge-${project.visibility}">
                            ${project.visibility}
                        </span>
                        ${isFromTraci ? '<span class="badge badge-traci">From TRAci</span>' : ''}
                    </div>
                    <div class="project-actions">
                        ${this.state.batchMode ? `
                            <input type="checkbox" class="project-select" 
                                   data-project-id="${project.id}"
                                   onchange="window.thoraxLab.toggleProjectSelection('${project.id}', this.checked)">
                        ` : ''}
                    </div>
                </div>
                
                <h3 class="project-title">${this.escapeHtml(project.title)}</h3>
                <p class="project-description">${this.escapeHtml(project.description?.substring(0, 150) || '')}...</p>
                
                ${project.tags?.length ? `
                    <div class="project-tags">
                        ${project.tags.slice(0, 3).map(tag => `
                            <span class="tag">${this.escapeHtml(tag)}</span>
                        `).join('')}
                    </div>
                ` : ''}
                
                <div class="project-footer">
                    <div class="project-meta">
                        <div class="project-owner">
                            <div class="avatar-small">${owner.full_name?.substring(0, 2).toUpperCase() || '??'}</div>
                            <span>${owner.full_name || 'Unknown'}</span>
                        </div>
                        <div class="project-date">
                            ${this.formatTimeAgo(project.created_at)}
                        </div>
                    </div>
                    <div class="project-stats">
                        <span><i class="fas fa-thumbs-up"></i> ${project.like_count || 0}</span>
                        <span><i class="fas fa-comment"></i> ${project.comment_count || 0}</span>
                    </div>
                </div>
            </div>
        `;
    }
    
    async renderDiscussions(discussions, container) {
        if (!container) return;
        
        if (!discussions || discussions.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-comments"></i>
                    <h3>No discussions yet</h3>
                    <p>Start the first discussion</p>
                    <button class="btn btn-primary" onclick="window.thoraxLab.showNewDiscussionModal()">
                        Start Discussion
                    </button>
                </div>
            `;
            return;
        }
        
        const html = discussions.map(discussion => this.renderDiscussionCard(discussion)).join('');
        container.innerHTML = html;
    }
    
    renderDiscussionCard(discussion) {
        const author = this.cache.profiles.get(discussion.author_id) || {};
        
        return `
            <div class="discussion-card" data-discussion-id="${discussion.id}">
                <div class="discussion-header">
                    <div class="discussion-author">
                        <div class="avatar">${author.full_name?.substring(0, 2).toUpperCase() || '??'}</div>
                        <div>
                            <div class="author-name">${author.full_name || 'Unknown'}</div>
                            <div class="discussion-date">${this.formatTimeAgo(discussion.created_at)}</div>
                        </div>
                    </div>
                </div>
                
                <h3 class="discussion-title">${this.escapeHtml(discussion.title)}</h3>
                <div class="discussion-content">
                    ${this.escapeHtml(discussion.content?.substring(0, 200) || '')}...
                </div>
                
                <div class="discussion-footer">
                    <div class="discussion-stats">
                        <span><i class="fas fa-comment"></i> ${discussion.comment_count || 0}</span>
                        <span><i class="fas fa-thumbs-up"></i> ${discussion.like_count || 0}</span>
                    </div>
                    <button class="btn btn-sm btn-outline" 
                            onclick="window.thoraxLab.showDiscussionDetails('${discussion.id}')">
                        Join Discussion
                    </button>
                </div>
            </div>
        `;
    }
    
    // ============================================
    // MODAL MANAGEMENT
    // ============================================
    
    showNewProjectModal() {
        this.createModal('newProjectModal', `
            <div class="modal-header">
                <h2>Create New Innovation Project</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="projectForm">
                    <div class="form-group">
                        <label for="projectTitle">Project Title *</label>
                        <input type="text" id="projectTitle" required 
                               placeholder="e.g., Smart Inhaler Adherence System">
                    </div>
                    <div class="form-group">
                        <label for="projectDescription">Description *</label>
                        <textarea id="projectDescription" required rows="4"
                                  placeholder="Describe the clinical need and innovation approach..."></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="projectType">Project Type *</label>
                            <select id="projectType" required>
                                <option value="">Select type</option>
                                <option value="clinical">Clinical-Led</option>
                                <option value="industry">Industry-Led</option>
                                <option value="collaboration">Collaboration</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="projectVisibility">Visibility *</label>
                            <select id="projectVisibility" required>
                                <option value="private">Private</option>
                                <option value="internal">Internal</option>
                                <option value="public">Public</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="projectTags">Tags</label>
                        <input type="text" id="projectTags" 
                               placeholder="e.g., COPD, digital health, medical device">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary modal-close">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary">
                            Create Project
                        </button>
                    </div>
                </form>
            </div>
        `);
        
        // Add form submission handler
        setTimeout(() => {
            document.getElementById('projectForm')?.addEventListener('submit', 
                (e) => this.createProject(e)
            );
        }, 100);
    }
    
    showNewDiscussionModal() {
        this.createModal('newDiscussionModal', `
            <div class="modal-header">
                <h2>Start New Discussion</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="discussionForm">
                    <div class="form-group">
                        <label for="discussionTitle">Title *</label>
                        <input type="text" id="discussionTitle" required 
                               placeholder="What would you like to discuss?">
                    </div>
                    <div class="form-group">
                        <label for="discussionContent">Content *</label>
                        <textarea id="discussionContent" rows="6" required
                                  placeholder="Share your thoughts, questions, or insights..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="discussionProject">Link to Project (Optional)</label>
                        <select id="discussionProject">
                            <option value="">None</option>
                            ${this.cache.projects.map(p => `
                                <option value="${p.id}">${this.escapeHtml(p.title)}</option>
                            `).join('')}
                        </select>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary modal-close">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i>
                            Post Discussion
                        </button>
                    </div>
                </form>
            </div>
        `);
        
        // Add form submission handler
        setTimeout(() => {
            document.getElementById('discussionForm')?.addEventListener('submit', 
                (e) => this.createDiscussion(e)
            );
        }, 100);
    }
    
    showImportModal(projectId) {
        const project = this.cache.projects.find(p => p.id === projectId);
        if (!project) return;
        
        this.createModal('importToTraciModal', `
            <div class="modal-header">
                <h2>Import "${this.escapeHtml(project.title.substring(0, 50))}" to TRAci</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="importProjectId" value="${projectId}">
                <div class="form-group">
                    <label for="importReviewStatus">TRAci Review Status *</label>
                    <select id="importReviewStatus" required>
                        <option value="needs_review">Needs Review</option>
                        <option value="archived">Archived</option>
                        <option value="active">Active</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="importNotes">Notes for TRAci Team</label>
                    <textarea id="importNotes" rows="3"
                              placeholder="Add context about this project..."></textarea>
                </div>
                <div class="info-box">
                    <i class="fas fa-info-circle"></i>
                    <p>Project will be created in TRAci with proper attribution</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary modal-close">
                    Cancel
                </button>
                <button type="button" class="btn btn-primary" onclick="window.thoraxLab.confirmImport()">
                    <i class="fas fa-download"></i>
                    Import to TRAci
                </button>
            </div>
        `);
    }
    
    showProjectDetails(project) {
        if (!project) return;
        
        const owner = this.cache.profiles.get(project.owner_id) || {};
        const isFromTraci = !!project.source_traci_project_id;
        
        this.createModal('projectDetailModal', `
            <div class="modal-header">
                <h2>${this.escapeHtml(project.title)}</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="project-detail-header">
                    <div class="project-owner-large">
                        <div class="avatar-large">${owner.full_name?.substring(0, 2).toUpperCase() || '??'}</div>
                        <div>
                            <div class="owner-name">${owner.full_name || 'Unknown'}</div>
                            <div class="owner-role">${owner.user_type || 'User'}</div>
                        </div>
                    </div>
                    <div class="project-meta">
                        <div class="badge badge-${project.project_type}">${project.project_type}</div>
                        <div class="badge badge-${project.visibility}">${project.visibility}</div>
                        ${isFromTraci ? '<div class="badge badge-traci">From TRAci</div>' : ''}
                    </div>
                </div>
                
                <div class="project-description-full">
                    <h3>Description</h3>
                    <p>${this.escapeHtml(project.description || 'No description').replace(/\n/g, '<br>')}</p>
                </div>
                
                ${project.tags?.length ? `
                    <div class="project-tags-full">
                        <h3>Tags</h3>
                        <div class="tags-container">
                            ${project.tags.map(tag => `
                                <span class="tag">${this.escapeHtml(tag)}</span>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                <div class="project-stats-full">
                    <div class="stat">
                        <div class="stat-value">${project.like_count || 0}</div>
                        <div class="stat-label">Likes</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">${project.comment_count || 0}</div>
                        <div class="stat-label">Comments</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">${project.view_count || 0}</div>
                        <div class="stat-label">Views</div>
                    </div>
                </div>
                
                ${!isFromTraci ? `
                    <div class="project-actions-full">
                        <button class="btn btn-primary" onclick="window.thoraxLab.showImportModal('${project.id}')">
                            <i class="fas fa-download"></i>
                            Import to TRAci
                        </button>
                        <button class="btn btn-outline" onclick="window.thoraxLab.likeProject('${project.id}')">
                            <i class="fas fa-thumbs-up"></i>
                            Like
                        </button>
                    </div>
                ` : ''}
            </div>
        `);
    }
    
    createModal(id, content) {
        // Remove existing modal
        const existing = document.getElementById(id);
        if (existing) existing.remove();
        
        // Create new modal
        const modal = document.createElement('div');
        modal.id = id;
        modal.className = 'modal-overlay active';
        modal.innerHTML = content;
        
        // Add to DOM
        document.body.appendChild(modal);
        
        // Add close handlers
        modal.querySelectorAll('.modal-close').forEach(btn => {
            btn.addEventListener('click', () => this.hideModal(id));
        });
        
        // Close on overlay click
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                this.hideModal(id);
            }
        });
        
        // Trap focus
        this.trapFocus(modal);
        
        return modal;
    }
    
    hideModal(id) {
        const modal = document.getElementById(id);
        if (modal) {
            modal.classList.remove('active');
            setTimeout(() => modal.remove(), 300);
        }
    }
    
    hideAllModals() {
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.classList.remove('active');
            setTimeout(() => modal.remove(), 300);
        });
    }
    
    // ============================================
    // DATA MANIPULATION METHODS
    // ============================================
    
    async createProject(e) {
        e.preventDefault();
        
        if (!this.state.currentUser) {
            this.showToast('Please sign in to create a project', 'error');
            return;
        }
        
        const title = document.getElementById('projectTitle')?.value.trim();
        const description = document.getElementById('projectDescription')?.value.trim();
        const type = document.getElementById('projectType')?.value;
        const visibility = document.getElementById('projectVisibility')?.value;
        const tagsInput = document.getElementById('projectTags')?.value.trim();
        
        if (!title || !description || !type || !visibility) {
            this.showToast('Please fill in all required fields', 'error');
            return;
        }
        
        const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];
        
        try {
            const projectData = {
                title,
                description,
                project_type: type,
                visibility,
                status: 'active',
                tags,
                owner_id: this.state.currentUser.id,
                owner_name: this.state.currentUser.full_name,
                comment_count: 0,
                like_count: 0,
                view_count: 0,
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            };
            
            const { data: project, error } = await this.supabase
                .from('thoraxlab_projects')
                .insert([projectData])
                .select()
                .single();
            
            if (error) throw error;
            
            // Add to cache
            this.cache.projects.unshift(project);
            
            // Create initial discussion
            await this.supabase
                .from('thoraxlab_discussions')
                .insert([{
                    title: `Discussion: ${title}`,
                    content: `Welcome to the discussion for "${title}"! Share your thoughts, ideas, and feedback.`,
                    project_id: project.id,
                    author_id: this.state.currentUser.id,
                    author_name: this.state.currentUser.full_name,
                    comment_count: 0,
                    like_count: 0,
                    created_at: new Date().toISOString()
                }]);
            
            this.showToast('Project created successfully!', 'success');
            this.hideModal('newProjectModal');
            
            // Refresh current view
            this.refreshCurrentView();
            
        } catch (error) {
            console.error('Error creating project:', error);
            this.showToast(`Failed to create project: ${error.message}`, 'error');
        }
    }
    
    async createDiscussion(e) {
        e.preventDefault();
        
        if (!this.state.currentUser) {
            this.showToast('Please sign in to create a discussion', 'error');
            return;
        }
        
        const title = document.getElementById('discussionTitle')?.value.trim();
        const content = document.getElementById('discussionContent')?.value.trim();
        const projectId = document.getElementById('discussionProject')?.value || null;
        
        if (!title || !content) {
            this.showToast('Title and content are required', 'error');
            return;
        }
        
        try {
            const discussionData = {
                title,
                content,
                project_id: projectId,
                author_id: this.state.currentUser.id,
                author_name: this.state.currentUser.full_name,
                comment_count: 0,
                like_count: 0,
                created_at: new Date().toISOString()
            };
            
            const { data: discussion, error } = await this.supabase
                .from('thoraxlab_discussions')
                .insert([discussionData])
                .select()
                .single();
            
            if (error) throw error;
            
            // Add to cache
            this.cache.discussions.unshift(discussion);
            
            this.showToast('Discussion started successfully!', 'success');
            this.hideModal('newDiscussionModal');
            
            // Refresh current view
            if (this.state.currentPage === 'discussions') {
                await this.loadDiscussionsPage();
            }
            
        } catch (error) {
            console.error('Error creating discussion:', error);
            this.showToast(`Failed to create discussion: ${error.message}`, 'error');
        }
    }
    
    async confirmImport() {
        const projectId = document.getElementById('importProjectId')?.value;
        const reviewStatus = document.getElementById('importReviewStatus')?.value;
        const notes = document.getElementById('importNotes')?.value.trim() || '';
        
        if (!projectId || !reviewStatus) {
            this.showToast('Please fill in all required fields', 'error');
            return;
        }
        
        const project = this.cache.projects.find(p => p.id === projectId);
        if (!project) {
            this.showToast('Project not found', 'error');
            return;
        }
        
        try {
            // Create TRAci project
            const traciProjectData = {
                name: project.title,
                description: `[Imported from ThoraxLab Collaboration Platform]\n\n${project.description}\n\n**Import Notes:** ${notes}`,
                status: reviewStatus === 'active' ? 'development' : 'planning',
                review_status: reviewStatus === 'active' ? 'none' : reviewStatus,
                visibility: 'private',
                progress: 0,
                created_at: new Date().toISOString(),
                last_updated: new Date().toISOString()
            };
            
            // Insert into TRAci projects table
            const { data: traciProject, error: traciError } = await this.supabase
                .from('projects')
                .insert([traciProjectData])
                .select()
                .single();
            
            if (traciError) {
                // If projects table doesn't exist, try a different approach
                console.warn('TRAci projects table not found, using alternative method');
                
                // Update ThoraxLab project with a marker
                const { error: updateError } = await this.supabase
                    .from('thoraxlab_projects')
                    .update({ 
                        traci_import_status: 'pending',
                        traci_import_notes: notes,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', projectId);
                
                if (updateError) throw updateError;
            } else {
                // Update ThoraxLab project with TRAci ID
                const { error: updateError } = await this.supabase
                    .from('thoraxlab_projects')
                    .update({ 
                        source_traci_project_id: traciProject.id,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', projectId);
                
                if (updateError) throw updateError;
                
                // Update cache
                project.source_traci_project_id = traciProject.id;
            }
            
            // Create sync record
            await this.supabase
                .from('project_sync')
                .insert([{
                    thoraxlab_project_id: projectId,
                    sync_direction: 'thoraxlab_to_traci',
                    initiated_by: this.state.currentUser.id,
                    initiated_at: new Date().toISOString(),
                    status: 'completed',
                    sync_notes: notes
                }]);
            
            this.showToast('Project imported to TRAci successfully!', 'success');
            this.hideModal('importToTraciModal');
            
            // Refresh view
            this.refreshCurrentView();
            
        } catch (error) {
            console.error('Import error:', error);
            this.showToast(`Failed to import project: ${error.message}`, 'error');
        }
    }
    
    // ============================================
    // REAL-TIME UPDATES
    // ============================================
    
    async setupRealtimeSubscriptions() {
        if (!this.state.currentUser) return;
        
        try {
            // Subscribe to projects
            this.channels.projects = this.supabase
                .channel('projects-channel')
                .on('postgres_changes', 
                    { 
                        event: '*', 
                        schema: 'public', 
                        table: 'thoraxlab_projects' 
                    },
                    (payload) => this.handleProjectUpdate(payload)
                )
                .subscribe();
            
            // Subscribe to discussions
            this.channels.discussions = this.supabase
                .channel('discussions-channel')
                .on('postgres_changes',
                    { 
                        event: '*', 
                        schema: 'public', 
                        table: 'thoraxlab_discussions' 
                    },
                    (payload) => this.handleDiscussionUpdate(payload)
                )
                .subscribe();
            
            console.log('âœ… Real-time subscriptions established');
            
        } catch (error) {
            console.error('Failed to setup real-time:', error);
        }
    }
    
    cleanupRealtimeSubscriptions() {
        Object.values(this.channels).forEach(channel => {
            if (channel) {
                this.supabase.removeChannel(channel);
            }
        });
        this.channels = { projects: null, discussions: null, comments: null };
    }
    
    handleProjectUpdate(payload) {
        const { eventType, new: newRecord, old: oldRecord } = payload;
        
        switch(eventType) {
            case 'INSERT':
                this.cache.projects.unshift(newRecord);
                this.refreshCurrentView();
                break;
                
            case 'UPDATE':
                const index = this.cache.projects.findIndex(p => p.id === newRecord.id);
                if (index !== -1) {
                    this.cache.projects[index] = newRecord;
                }
                this.refreshCurrentView();
                break;
                
            case 'DELETE':
                this.cache.projects = this.cache.projects.filter(p => p.id !== oldRecord.id);
                this.refreshCurrentView();
                break;
        }
    }
    
    handleDiscussionUpdate(payload) {
        const { eventType, new: newRecord, old: oldRecord } = payload;
        
        switch(eventType) {
            case 'INSERT':
                this.cache.discussions.unshift(newRecord);
                if (this.state.currentPage === 'discussions') {
                    this.loadDiscussionsPage();
                }
                break;
                
            case 'UPDATE':
                const index = this.cache.discussions.findIndex(d => d.id === newRecord.id);
                if (index !== -1) {
                    this.cache.discussions[index] = newRecord;
                }
                if (this.state.currentPage === 'discussions') {
                    this.loadDiscussionsPage();
                }
                break;
                
            case 'DELETE':
                this.cache.discussions = this.cache.discussions.filter(d => d.id !== oldRecord.id);
                if (this.state.currentPage === 'discussions') {
                    this.loadDiscussionsPage();
                }
                break;
        }
    }
    
    // ============================================
    // BATCH OPERATIONS
    // ============================================
    
    toggleBatchMode() {
        this.state.batchMode = !this.state.batchMode;
        this.state.selectedProjects.clear();
        
        const batchOps = document.getElementById('batchOperations');
        if (batchOps) {
            batchOps.classList.toggle('hidden', !this.state.batchMode);
        }
        
        // Refresh projects to show/hide checkboxes
        this.refreshCurrentView();
    }
    
    toggleProjectSelection(projectId, selected) {
        if (selected) {
            this.state.selectedProjects.add(projectId);
        } else {
            this.state.selectedProjects.delete(projectId);
        }
        
        // Update selection count
        const selectedCount = document.getElementById('selectedCount');
        if (selectedCount) {
            selectedCount.textContent = this.state.selectedProjects.size;
        }
    }
    
    async bulkExport() {
        const selectedProjects = Array.from(this.state.selectedProjects);
        if (selectedProjects.length === 0) {
            this.showToast('Please select projects to export', 'warning');
            return;
        }
        
        const projects = this.cache.projects.filter(p => 
            this.state.selectedProjects.has(p.id)
        );
        
        // Create export data
        const exportData = {
            exportedAt: new Date().toISOString(),
            exportedBy: this.state.currentUser?.full_name || 'Unknown',
            count: projects.length,
            projects: projects
        };
        
        // Convert to JSON and download
        const blob = new Blob([JSON.stringify(exportData, null, 2)], 
            { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `thoraxlab-projects-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        this.showToast(`Exported ${projects.length} projects`, 'success');
    }
    
    async bulkArchive() {
        const selectedProjects = Array.from(this.state.selectedProjects);
        if (selectedProjects.length === 0) {
            this.showToast('Please select projects to archive', 'warning');
            return;
        }
        
        if (!confirm(`Archive ${selectedProjects.length} projects?`)) {
            return;
        }
        
        try {
            const { error } = await this.supabase
                .from('thoraxlab_projects')
                .update({ status: 'archived' })
                .in('id', selectedProjects);
            
            if (error) throw error;
            
            this.showToast(`Archived ${selectedProjects.length} projects`, 'success');
            this.toggleBatchMode();
            
        } catch (error) {
            this.showToast('Failed to archive projects', 'error');
        }
    }
    
    async bulkDelete() {
        const selectedProjects = Array.from(this.state.selectedProjects);
        if (selectedProjects.length === 0) {
            this.showToast('Please select projects to delete', 'warning');
            return;
        }
        
        if (!confirm(`Permanently delete ${selectedProjects.length} projects? This cannot be undone.`)) {
            return;
        }
        
        try {
            const { error } = await this.supabase
                .from('thoraxlab_projects')
                .delete()
                .in('id', selectedProjects);
            
            if (error) throw error;
            
            this.showToast(`Deleted ${selectedProjects.length} projects`, 'success');
            this.toggleBatchMode();
            
        } catch (error) {
            this.showToast('Failed to delete projects', 'error');
        }
    }
    
    clearSelection() {
        this.state.selectedProjects.clear();
        const selectedCount = document.getElementById('selectedCount');
        if (selectedCount) {
            selectedCount.textContent = '0';
        }
        this.refreshCurrentView();
    }
    
    // ============================================
    // TRAci INTEGRATION
    // ============================================
    
    async syncTraciProjects() {
        this.showLoading('Syncing with TRAci...');
        
        try {
            // Get TRAci projects that are published to ThoraxLab
            const { data: traciProjects, error: traciError } = await this.supabase
                .from('projects')
                .select('*')
                .eq('review_status', 'published_to_thoraxlab')
                .order('last_updated', { ascending: false });
            
            if (traciError) {
                // If projects table doesn't exist, simulate data
                console.warn('TRAci projects table not found, using mock data');
                await this.simulateTraciSync();
                return;
            }
            
            let newProjectsCount = 0;
            
            for (const traciProject of traciProjects || []) {
                // Check if already exists
                const exists = this.cache.projects.some(
                    p => p.source_traci_project_id === traciProject.id
                );
                
                if (exists) continue;
                
                // Create ThoraxLab project
                const thoraxlabProject = {
                    title: traciProject.name,
                    description: `[Published from TRAci Clinical Platform]\n\n${traciProject.description}`,
                    project_type: 'clinical',
                    visibility: 'internal',
                    status: 'active',
                    source_traci_project_id: traciProject.id,
                    owner_id: 'traci-platform',
                    owner_name: 'TRAci Platform',
                    tags: ['clinical', 'pulmonology', 'traci_platform'],
                    comment_count: 0,
                    like_count: 0,
                    view_count: 0,
                    created_at: traciProject.created_at || new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                
                const { data: newProject, error: createError } = await this.supabase
                    .from('thoraxlab_projects')
                    .insert([thoraxlabProject])
                    .select()
                    .single();
                
                if (createError) {
                    console.error('Error creating project:', createError);
                    continue;
                }
                
                // Create discussion
                await this.supabase
                    .from('thoraxlab_discussions')
                    .insert([{
                        title: `Clinical Innovation: ${traciProject.name}`,
                        content: `This project was published from our clinical TRAci platform. Let's discuss how industry can collaborate with clinical experts.`,
                        project_id: newProject.id,
                        author_id: 'traci-platform',
                        author_name: 'TRAci Platform',
                        comment_count: 0,
                        like_count: 0,
                        created_at: new Date().toISOString()
                    }]);
                
                newProjectsCount++;
            }
            
            // Refresh data
            await this.loadProjects();
            await this.loadDiscussions();
            
            this.showToast(`Synced ${newProjectsCount} new projects from TRAci`, 'success');
            
            // Refresh current view
            if (this.state.currentPage === 'fromtraci') {
                await this.loadTraciProjects();
            }
            
        } catch (error) {
            console.error('Sync error:', error);
            this.showToast('Failed to sync with TRAci', 'error');
        } finally {
            this.hideLoading();
        }
    }
    
    async simulateTraciSync() {
        // Create mock TRAci projects for demonstration
        const mockProjects = [
            {
                id: 'traci-1',
                name: 'AI-Powered COPD Diagnosis System',
                description: 'Machine learning system for early COPD detection using chest X-rays',
                status: 'active',
                progress: 75
            },
            {
                id: 'traci-2',
                name: 'Smart Spirometer with Mobile App',
                description: 'Connected spirometer for home monitoring of lung function',
                status: 'development',
                progress: 50
            }
        ];
        
        for (const mockProject of mockProjects) {
            const exists = this.cache.projects.some(
                p => p.source_traci_project_id === mockProject.id
            );
            
            if (exists) continue;
            
            const thoraxlabProject = {
                title: mockProject.name,
                description: `[Published from TRAci Clinical Platform]\n\n${mockProject.description}\n\nStatus: ${mockProject.status}\nProgress: ${mockProject.progress}%`,
                project_type: 'clinical',
                visibility: 'internal',
                status: 'active',
                source_traci_project_id: mockProject.id,
                owner_id: 'traci-platform',
                owner_name: 'TRAci Platform',
                tags: ['clinical', 'ai', 'diagnostics', 'traci_platform'],
                comment_count: 0,
                like_count: 0,
                view_count: 0,
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            };
            
            const { data: newProject, error } = await this.supabase
                .from('thoraxlab_projects')
                .insert([thoraxlabProject])
                .select()
                .single();
            
            if (!error && newProject) {
                await this.supabase
                    .from('thoraxlab_discussions')
                    .insert([{
                        title: `Clinical Innovation: ${mockProject.name}`,
                        content: `This project was published from our clinical TRAci platform. Let's discuss how industry can collaborate with clinical experts.`,
                        project_id: newProject.id,
                        author_id: 'traci-platform',
                        author_name: 'TRAci Platform',
                        comment_count: 0,
                        like_count: 0,
                        created_at: new Date().toISOString()
                    }]);
            }
        }
        
        // Refresh data
        await this.loadProjects();
        await this.loadDiscussions();
        
        this.showToast('Synced mock TRAci projects for demonstration', 'info');
        
        if (this.state.currentPage === 'fromtraci') {
            await this.loadTraciProjects();
        }
    }
    
    // ============================================
    // UTILITY METHODS
    // ============================================
    
    navigateTo(page) {
        window.location.hash = page;
    }
    
    async handleRoute() {
        const hash = window.location.hash.substring(1) || 'dashboard';
        this.state.currentPage = hash;
        
        await this.showPage(hash);
        this.updateNavigation(hash);
    }
    
    async showPage(page) {
        const mainContent = document.querySelector('.main-content');
        if (!mainContent) return;
        
        // Show loading
        this.showLoading();
        
        try {
            // Get page content
            const pageObj = this.state.pages[page];
            if (!pageObj) {
                this.navigateTo('dashboard');
                return;
            }
            
            // Render page
            const content = await pageObj.render();
            mainContent.innerHTML = content;
            
            // Load page data
            await pageObj.load();
            
            // Update navigation
            this.updateNavigation(page);
            
        } catch (error) {
            console.error(`Error showing page ${page}:`, error);
            mainContent.innerHTML = `
                <div class="error-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h2>Error Loading Page</h2>
                    <p>${error.message}</p>
                    <button class="btn btn-primary" onclick="window.thoraxLab.navigateTo('dashboard')">
                        Go to Dashboard
                    </button>
                </div>
            `;
        } finally {
            this.hideLoading();
        }
    }
    
    updateNavigation(page) {
        // Update desktop nav
        document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.toggle('active', link.dataset.page === page);
        });
        
        // Update mobile nav
        document.querySelectorAll('.nav-item').forEach(item => {
            const href = item.getAttribute('href');
            if (href) {
                item.classList.toggle('active', href.substring(1) === page);
            }
        });
        
        // Hide mobile menu
        document.getElementById('mainNav')?.classList.remove('active');
    }
    
    showAuthScreen() {
        document.getElementById('authScreen').classList.remove('hidden');
        document.getElementById('mainApp').classList.add('hidden');
        this.hideAllModals();
    }
    
    showApplication() {
        document.getElementById('authScreen').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        this.updateUserDisplay();
    }
    
    updateUserDisplay() {
        if (!this.state.currentUser) return;
        
        // Update avatar
        const userAvatar = document.getElementById('userInitials');
        if (userAvatar) {
            userAvatar.textContent = this.state.currentUser.avatar;
        }
        
        // Update dropdown
        const dropdownName = document.getElementById('dropdownUserName');
        const dropdownRole = document.getElementById('dropdownUserRole');
        
        if (dropdownName && dropdownRole) {
            dropdownName.textContent = this.state.currentUser.full_name;
            dropdownRole.textContent = this.state.currentUser.user_type;
            if (this.state.isAdmin) {
                dropdownRole.textContent += ' (Admin)';
            }
        }
        
        // Update welcome message
        const welcomeMessage = document.getElementById('welcomeMessage');
        if (welcomeMessage) {
            const firstName = this.state.currentUser.full_name.split(' ')[0];
            welcomeMessage.textContent = `Welcome back, ${firstName}!`;
        }
        
        // Show/hide admin nav
        document.querySelectorAll('.admin-only').forEach(el => {
            el.classList.toggle('hidden', !this.state.isAdmin);
        });
    }
    
    showLoading(message = 'Loading...') {
        const loadingEl = document.getElementById('globalLoading');
        if (loadingEl) {
            loadingEl.classList.remove('hidden');
            loadingEl.querySelector('.loading-text').textContent = message;
        }
    }
    
    hideLoading() {
        const loadingEl = document.getElementById('globalLoading');
        if (loadingEl) {
            loadingEl.classList.add('hidden');
        }
    }
    
    showToast(message, type = 'info') {
        const container = document.getElementById('toastContainer');
        if (!container) return;
        
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        
        const icons = {
            success: 'fa-check-circle',
            error: 'fa-exclamation-circle',
            warning: 'fa-exclamation-triangle',
            info: 'fa-info-circle'
        };
        
        toast.innerHTML = `
            <i class="fas ${icons[type] || 'fa-info-circle'}"></i>
            <div class="toast-content">
                <div class="toast-message">${this.escapeHtml(message)}</div>
            </div>
            <button class="toast-close">&times;</button>
        `;
        
        container.appendChild(toast);
        
        // Auto remove
        setTimeout(() => {
            toast.classList.add('toast-exit');
            setTimeout(() => toast.remove(), 300);
        }, 5000);
        
        // Close button
        toast.querySelector('.toast-close').addEventListener('click', () => {
            toast.classList.add('toast-exit');
            setTimeout(() => toast.remove(), 300);
        });
    }
    
    refreshCurrentView() {
        this.showPage(this.state.currentPage);
    }
    
    // ============================================
    // HELPER METHODS
    // ============================================
    
    escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    formatTimeAgo(dateString) {
        try {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        } catch (error) {
            return 'Recently';
        }
    }
    
    generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            const r = Math.random() * 16 | 0;
            const v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }
    
    loadSavedSearches() {
        try {
            return JSON.parse(localStorage.getItem('thoraxlab_saved_searches')) || {};
        } catch {
            return {};
        }
    }
    
    loadUserPreferences() {
        try {
            return JSON.parse(localStorage.getItem('thoraxlab_preferences')) || {};
        } catch {
            return {};
        }
    }
    
    applyFilters(projects) {
        let filtered = projects;
        
        // Type filter
        const typeFilter = document.getElementById('projectTypeFilter')?.value;
        if (typeFilter && typeFilter !== 'all') {
            filtered = filtered.filter(p => p.project_type === typeFilter);
        }
        
        // Status filter
        const statusFilter = document.getElementById('projectStatusFilter')?.value;
        if (statusFilter && statusFilter !== 'all') {
            filtered = filtered.filter(p => p.status === statusFilter);
        }
        
        return filtered;
    }
    
    searchProjects(projects, query) {
        if (!query.trim()) return projects;
        
        const searchTerms = query.toLowerCase().split(' ');
        
        return projects.filter(project => {
            const searchText = `
                ${project.title || ''}
                ${project.description || ''}
                ${(project.tags || []).join(' ')}
            `.toLowerCase();
            
            return searchTerms.every(term => searchText.includes(term));
        });
    }
    
    setupProjectFilters() {
        // Search input
        const searchInput = document.getElementById('projectSearch');
        if (searchInput) {
            let debounceTimer;
            searchInput.addEventListener('input', (e) => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    this.state.searchQuery = e.target.value;
                    this.loadAllProjects();
                }, 300);
            });
        }
        
        // Type filter
        const typeFilter = document.getElementById('projectTypeFilter');
        if (typeFilter) {
            typeFilter.addEventListener('change', () => {
                this.loadAllProjects();
            });
        }
        
        // Status filter
        const statusFilter = document.getElementById('projectStatusFilter');
        if (statusFilter) {
            statusFilter.addEventListener('change', () => {
                this.loadAllProjects();
            });
        }
    }
    
    setupDiscussionFilters() {
        // Filter buttons
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => 
                    b.classList.remove('active')
                );
                btn.classList.add('active');
                // Apply filter logic here
            });
        });
        
        // Search input
        const searchInput = document.getElementById('discussionSearch');
        if (searchInput) {
            let debounceTimer;
            searchInput.addEventListener('input', (e) => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    // Apply search logic here
                }, 300);
            });
        }
    }
    
    async loadActivityFeed() {
        const activityFeed = document.getElementById('activityFeed');
        if (!activityFeed) return;
        
        // Combine recent activities from projects and discussions
        const recentProjects = this.cache.projects.slice(0, 5);
        const recentDiscussions = this.cache.discussions.slice(0, 5);
        
        const activities = [
            ...recentProjects.map(p => ({
                type: 'project',
                title: 'New project created',
                item: p.title,
                author: this.cache.profiles.get(p.owner_id)?.full_name || 'Unknown',
                time: this.formatTimeAgo(p.created_at),
                icon: 'fa-project-diagram',
                color: 'blue'
            })),
            ...recentDiscussions.map(d => ({
                type: 'discussion',
                title: 'New discussion started',
                item: d.title,
                author: this.cache.profiles.get(d.author_id)?.full_name || 'Unknown',
                time: this.formatTimeAgo(d.created_at),
                icon: 'fa-comments',
                color: 'green'
            }))
        ].sort((a, b) => new Date(b.time) - new Date(a.time)).slice(0, 8);
        
        if (activities.length === 0) {
            activityFeed.innerHTML = `
                <div class="empty-activity">
                    <i class="fas fa-history"></i>
                    <p>No recent activity</p>
                </div>
            `;
            return;
        }
        
        activityFeed.innerHTML = activities.map(activity => `
            <div class="activity-item">
                <div class="activity-icon" style="background: var(--${activity.color})">
                    <i class="fas ${activity.icon}"></i>
                </div>
                <div class="activity-content">
                    <div class="activity-title">${activity.title}</div>
                    <div class="activity-item">${this.escapeHtml(activity.item)}</div>
                    <div class="activity-meta">
                        <span class="activity-author">by ${activity.author}</span>
                        <span class="activity-time">${activity.time}</span>
                    </div>
                </div>
            </div>
        `).join('');
    }
    
    async checkNotifications() {
        if (!this.state.currentUser) return;
        
        try {
            // Check for mentions in discussions
            const { data: mentions } = await this.supabase
                .from('thoraxlab_discussions')
                .select('*')
                .ilike('content', `%@${this.state.currentUser.full_name}%`)
                .limit(10);
            
            // Check for project updates
            const userProjects = this.cache.projects.filter(
                p => p.owner_id === this.state.currentUser.id
            );
            
            const notifications = [
                ...(mentions || []).map(m => ({
                    type: 'mention',
                    title: 'You were mentioned',
                    message: `in "${m.title}"`,
                    timestamp: m.created_at
                })),
                ...userProjects.map(p => ({
                    type: 'project_update',
                    title: 'Project updated',
                    message: `"${p.title}" has new activity`,
                    timestamp: p.updated_at
                }))
            ];
            
            this.state.notifications = notifications;
            this.updateNotificationBadge();
            
        } catch (error) {
            console.error('Error checking notifications:', error);
        }
    }
    
    updateNotificationBadge() {
        const count = this.state.notifications.length;
        const badge = document.getElementById('notificationCount');
        const navBadge = document.getElementById('unreadBadge');
        
        if (badge) {
            if (count > 0) {
                badge.textContent = count > 99 ? '99+' : count.toString();
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }
        
        if (navBadge) {
            if (count > 0) {
                navBadge.textContent = count > 99 ? '99+' : count.toString();
                navBadge.classList.remove('hidden');
            } else {
                navBadge.classList.add('hidden');
            }
        }
    }
    
    handleKeyboardShortcut(e) {
        // Ignore in input fields
        if (e.target.tagName.match(/INPUT|TEXTAREA|SELECT/)) {
            return;
        }
        
        const key = e.key.toLowerCase();
        let shortcutKey = '';
        
        if (e.ctrlKey || e.metaKey) shortcutKey += 'ctrl+';
        if (e.altKey) shortcutKey += 'alt+';
        if (e.shiftKey) shortcutKey += 'shift+';
        shortcutKey += key;
        
        const handler = this.shortcuts.get(shortcutKey);
        if (handler) {
            e.preventDefault();
            handler(e);
        }
    }
    
    showKeyboardHelp() {
        const helpEl = document.getElementById('keyboardShortcuts');
        if (helpEl) {
            helpEl.classList.toggle('hidden');
        }
    }
    
    focusSearch() {
        const searchInput = document.getElementById('globalSearch');
        if (searchInput) {
            searchInput.focus();
        }
    }
    
    toggleMobileMenu() {
        const nav = document.getElementById('mainNav');
        if (nav) {
            nav.classList.toggle('active');
        }
    }
    
    togglePasswordVisibility() {
        const passwordInput = document.getElementById('password');
        const toggleBtn = document.getElementById('passwordToggle');
        
        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            toggleBtn.textContent = 'Hide';
        } else {
            passwordInput.type = 'password';
            toggleBtn.textContent = 'Show';
        }
    }
    
    trapFocus(modal) {
        const focusable = modal.querySelectorAll(
            'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
        );
        
        if (focusable.length === 0) return;
        
        const first = focusable[0];
        const last = focusable[focusable.length - 1];
        
        modal.addEventListener('keydown', (e) => {
            if (e.key === 'Tab') {
                if (e.shiftKey) {
                    if (document.activeElement === first) {
                        last.focus();
                        e.preventDefault();
                    }
                } else {
                    if (document.activeElement === last) {
                        first.focus();
                        e.preventDefault();
                    }
                }
            }
        });
        
        // Focus first element
        setTimeout(() => first?.focus(), 100);
    }
    
    handleClickOutside(e) {
        // Close user dropdown
        const userDropdown = document.getElementById('userDropdown');
        const userToggle = document.getElementById('userMenuToggle');
        if (userDropdown && !userDropdown.contains(e.target) && !userToggle?.contains(e.target)) {
            userDropdown.classList.add('hidden');
        }
        
        // Close search dropdown
        const searchDropdown = document.querySelector('.search-dropdown');
        const searchToggle = document.querySelector('.search-toggle');
        if (searchDropdown && !searchDropdown.contains(e.target) && !searchToggle?.contains(e.target)) {
            searchDropdown.classList.add('hidden');
        }
    }
    
    handleResize() {
        // Handle responsive behaviors
        const isMobile = window.innerWidth < 768;
        
        // Close dropdowns on mobile
        if (isMobile) {
            document.getElementById('userDropdown')?.classList.add('hidden');
            document.querySelector('.search-dropdown')?.classList.add('hidden');
        }
    }
    
    // ============================================
    // TEMPLATE SYSTEM
    // ============================================
    
    async useTemplate(templateId) {
        const templates = {
            'clinical-trial': {
                name: "Clinical Trial Protocol",
                description: "Template for clinical trial protocol development with sections for background, objectives, methods, and timeline.",
                type: "clinical",
                tags: ["clinical-trial", "protocol", "research", "ethics"],
                sections: [
                    "## Background\n\nDescribe the clinical problem and current state of knowledge.",
                    "## Objectives\n\nPrimary and secondary objectives of the trial.",
                    "## Methods\n\nStudy design, participants, interventions, and outcomes.",
                    "## Timeline\n\nKey milestones and estimated completion dates."
                ]
            },
            'device-development': {
                name: "Medical Device Development",
                description: "Template for medical device innovation projects including specifications, regulatory strategy, and testing plans.",
                type: "industry",
                tags: ["medical-device", "development", "fda", "regulatory"],
                sections: [
                    "## Specifications\n\nTechnical specifications and requirements.",
                    "## Regulatory Strategy\n\nFDA pathway and regulatory considerations.",
                    "## Testing Plan\n\nPre-clinical and clinical testing requirements.",
                    "## Manufacturing\n\nProduction and quality control processes."
                ]
            }
        };
        
        const template = templates[templateId];
        if (!template) return;
        
        // Show new project modal with template pre-filled
        this.showNewProjectModal();
        
        // Wait for modal to render
        setTimeout(() => {
            document.getElementById('projectTitle').value = template.name;
            document.getElementById('projectDescription').value = template.sections.join('\n\n');
            document.getElementById('projectType').value = template.type;
            document.getElementById('projectTags').value = template.tags.join(', ');
        }, 100);
    }
    
    // ============================================
    // ADMIN METHODS
    // ============================================
    
    async loadAdminDashboard() {
        if (!this.state.isAdmin) return;
        
        // Load admin stats
        const stats = await this.loadStats();
        
        const adminStats = document.getElementById('adminStats');
        if (adminStats) {
            adminStats.innerHTML = `
                <div class="admin-stat-card">
                    <div class="stat-value">${stats.totalUsers}</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="admin-stat-card">
                    <div class="stat-value">${stats.totalProjects}</div>
                    <div class="stat-label">Total Projects</div>
                </div>
                <div class="admin-stat-card">
                    <div class="stat-value">${stats.totalDiscussions}</div>
                    <div class="stat-label">Discussions</div>
                </div>
                <div class="admin-stat-card">
                    <div class="stat-value">${stats.traciProjects}</div>
                    <div class="stat-label">TRAci Projects</div>
                </div>
            `;
        }
        
        // Load users tab
        await this.loadAdminUsers();
    }
    
    async loadAdminUsers() {
        const usersTab = document.getElementById('usersTab');
        if (!usersTab) return;
        
        try {
            const { data: users, error } = await this.supabase
                .from('thoraxlab_profiles')
                .select('*')
                .order('created_at', { ascending: false });
            
            if (error) throw error;
            
            usersTab.innerHTML = `
                <div class="admin-section">
                    <div class="section-header">
                        <h3>User Management</h3>
                        <button class="btn btn-primary btn-sm" onclick="window.thoraxLab.showAddUserModal()">
                            <i class="fas fa-plus"></i> Add User
                        </button>
                    </div>
                    <div class="admin-table-container">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Institution/Company</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${users.map(user => `
                                    <tr>
                                        <td>${this.escapeHtml(user.full_name)}</td>
                                        <td><span class="badge badge-${user.user_type}">${user.user_type}</span></td>
                                        <td>${this.escapeHtml(user.hospital_institution || user.company || '-')}</td>
                                        <td><span class="badge ${user.is_verified ? 'badge-success' : 'badge-warning'}">
                                            ${user.is_verified ? 'Verified' : 'Pending'}
                                        </span></td>
                                        <td>
                                            <button class="btn btn-sm btn-secondary" onclick="window.thoraxLab.editUser('${user.user_id}')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-danger" onclick="window.thoraxLab.deleteUser('${user.user_id}')">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        } catch (error) {
            console.error('Error loading admin users:', error);
            usersTab.innerHTML = `
                <div class="error-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>Failed to load users</p>
                </div>
            `;
        }
    }
    
    showAddUserModal() {
        this.createModal('addUserModal', `
            <div class="modal-header">
                <h2>Add New User</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addUserForm">
                    <div class="form-group">
                        <label for="newUserName">Full Name *</label>
                        <input type="text" id="newUserName" required>
                    </div>
                    <div class="form-group">
                        <label for="newUserEmail">Email Address</label>
                        <input type="email" id="newUserEmail">
                    </div>
                    <div class="form-group">
                        <label for="newUserType">User Type *</label>
                        <select id="newUserType" required>
                            <option value="">Select type</option>
                            <option value="clinical">Clinical Professional</option>
                            <option value="industry">Industry Professional</option>
                            <option value="guest">Guest Contributor</option>
                            <option value="admin">Administrator</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="newUserPassword">Initial Password *</label>
                        <input type="password" id="newUserPassword" required>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary modal-close">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary">
                            Add User
                        </button>
                    </div>
                </form>
            </div>
        `);
        
        // Add form submission handler
        setTimeout(() => {
            document.getElementById('addUserForm')?.addEventListener('submit', 
                (e) => this.addUser(e)
            );
        }, 100);
    }
    
    async addUser(e) {
        e.preventDefault();
        
        const name = document.getElementById('newUserName')?.value.trim();
        const email = document.getElementById('newUserEmail')?.value.trim();
        const type = document.getElementById('newUserType')?.value;
        const password = document.getElementById('newUserPassword')?.value;
        
        if (!name || !type || !password) {
            this.showToast('Please fill in all required fields', 'error');
            return;
        }
        
        try {
            const userData = {
                user_id: this.generateUUID(),
                full_name: name,
                user_type: type,
                password_hash: password,
                is_verified: type === 'admin',
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            };
            
            if (email) {
                userData.email = email;
            }
            
            const { error } = await this.supabase
                .from('thoraxlab_profiles')
                .insert([userData]);
            
            if (error) throw error;
            
            this.showToast('User added successfully', 'success');
            this.hideModal('addUserModal');
            
            // Refresh admin users
            await this.loadAdminUsers();
            
        } catch (error) {
            console.error('Error adding user:', error);
            this.showToast(`Failed to add user: ${error.message}`, 'error');
        }
    }
    
    async editUser(userId) {
        // Implementation for editing user
        this.showToast('Edit user functionality coming soon', 'info');
    }
    
    async deleteUser(userId) {
        if (!confirm('Are you sure you want to delete this user?')) {
            return;
        }
        
        try {
            const { error } = await this.supabase
                .from('thoraxlab_profiles')
                .delete()
                .eq('user_id', userId);
            
            if (error) throw error;
            
            this.showToast('User deleted', 'success');
            
            // Refresh admin users
            await this.loadAdminUsers();
            
        } catch (error) {
            this.showToast('Failed to delete user', 'error');
        }
    }
    
    async exportData() {
        try {
            // Export all data
            const exportData = {
                exportedAt: new Date().toISOString(),
                exportedBy: this.state.currentUser?.full_name || 'Admin',
                projects: this.cache.projects,
                discussions: this.cache.discussions,
                users: Array.from(this.cache.profiles.values())
            };
            
            // Convert to JSON and download
            const blob = new Blob([JSON.stringify(exportData, null, 2)], 
                { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `thoraxlab-export-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            this.showToast('Data exported successfully', 'success');
            
        } catch (error) {
            console.error('Export error:', error);
            this.showToast('Failed to export data', 'error');
        }
    }
    
    refreshAdmin() {
        this.loadAdminDashboard();
        this.showToast('Admin dashboard refreshed', 'success');
    }
    
    // ============================================
    // PROFILE METHODS
    // ============================================
    
    async loadProfileData() {
        if (!this.state.currentUser) return;
        
        // Calculate user stats
        const userProjects = this.cache.projects.filter(
            p => p.owner_id === this.state.currentUser.id
        ).length;
        
        const userDiscussions = this.cache.discussions.filter(
            d => d.author_id === this.state.currentUser.id
        ).length;
        
        // Update profile stats
        document.getElementById('profileProjects')?.textContent = userProjects;
        document.getElementById('profileDiscussions')?.textContent = userDiscussions;
        
        // Update expertise tags
        const expertiseEl = document.getElementById('profileExpertise');
        if (expertiseEl && this.state.currentUser.expertise) {
            expertiseEl.innerHTML = this.state.currentUser.expertise
                .map(exp => `<span class="tag">${this.escapeHtml(exp)}</span>`)
                .join('');
        }
    }
    
    editProfile() {
        this.createModal('editProfileModal', `
            <div class="modal-header">
                <h2>Edit Profile</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editProfileForm">
                    <div class="form-group">
                        <label for="editFullName">Full Name *</label>
                        <input type="text" id="editFullName" 
                               value="${this.escapeHtml(this.state.currentUser?.full_name || '')}" 
                               required>
                    </div>
                    <div class="form-group">
                        <label for="editEmail">Email Address</label>
                        <input type="email" id="editEmail" 
                               value="${this.escapeHtml(this.state.currentUser?.email || '')}">
                    </div>
                    <div class="form-group">
                        <label for="editSpecialty">Specialty/Role</label>
                        <input type="text" id="editSpecialty" 
                               value="${this.escapeHtml(this.state.currentUser?.clinical_specialty || this.state.currentUser?.professional_role || '')}">
                    </div>
                    <div class="form-group">
                        <label for="editInstitution">Institution/Company</label>
                        <input type="text" id="editInstitution" 
                               value="${this.escapeHtml(this.state.currentUser?.hospital_institution || this.state.currentUser?.company || '')}">
                    </div>
                    <div class="form-group">
                        <label for="editExpertise">Areas of Expertise</label>
                        <input type="text" id="editExpertise" 
                               value="${this.escapeHtml((this.state.currentUser?.expertise || []).join(', '))}">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary modal-close">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary">
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>
        `);
        
        // Add form submission handler
        setTimeout(() => {
            document.getElementById('editProfileForm')?.addEventListener('submit', 
                (e) => this.saveProfile(e)
            );
        }, 100);
    }
    
    async saveProfile(e) {
        e.preventDefault();
        
        if (!this.state.currentUser) return;
        
        const fullName = document.getElementById('editFullName')?.value.trim();
        const email = document.getElementById('editEmail')?.value.trim();
        const specialty = document.getElementById('editSpecialty')?.value.trim();
        const institution = document.getElementById('editInstitution')?.value.trim();
        const expertiseInput = document.getElementById('editExpertise')?.value.trim();
        
        if (!fullName) {
            this.showToast('Full name is required', 'error');
            return;
        }
        
        const expertise = expertiseInput ? 
            expertiseInput.split(',').map(e => e.trim()).filter(e => e) : 
            [];
        
        try {
            const updates = {
                full_name: fullName,
                email: email || null,
                updated_at: new Date().toISOString()
            };
            
            // Add role-specific fields
            if (this.state.currentUser.user_type === 'clinical') {
                updates.clinical_specialty = specialty || null;
                updates.hospital_institution = institution || null;
            } else if (this.state.currentUser.user_type === 'industry') {
                updates.professional_role = specialty || null;
                updates.company = institution || null;
            }
            
            updates.expertise = expertise;
            
            const { error } = await this.supabase
                .from('thoraxlab_profiles')
                .update(updates)
                .eq('user_id', this.state.currentUser.id);
            
            if (error) throw error;
            
            // Update current user
            Object.assign(this.state.currentUser, updates);
            
            // Update localStorage
            localStorage.setItem('thoraxlab_user', JSON.stringify(this.state.currentUser));
            
            this.showToast('Profile updated successfully', 'success');
            this.hideModal('editProfileModal');
            
            // Refresh profile page
            if (this.state.currentPage === 'profile') {
                await this.showPage('profile');
            }
            
        } catch (error) {
            console.error('Error saving profile:', error);
            this.showToast(`Failed to update profile: ${error.message}`, 'error');
        }
    }
    
    // ============================================
    // PUBLIC API
    // ============================================
    
    // These methods are called from HTML onclick attributes
    
    showQuickActions() {
        const menu = document.getElementById('quickActionsMenu');
        if (menu) {
            menu.classList.toggle('hidden');
        }
    }
    
    likeProject(projectId) {
        // Implementation for liking a project
        this.showToast('Project liked!', 'success');
    }
    
    showDiscussionDetails(discussionId) {
        // Implementation for showing discussion details
        this.showToast('Discussion details coming soon', 'info');
    }
}

// ============================================
// INITIALIZATION
// ============================================

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
    window.thoraxLab = new ThoraxLab();
});

// Add remaining CSS
const remainingCSS = `
/* ===== COMPONENTS ===== */
.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    border-radius: 12px;
    font-weight: 600;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
    min-height: 44px;
    background: var(--clinical-blue);
    color: white;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
}

.btn-primary {
    background: linear-gradient(135deg, var(--clinical-blue), var(--industry-teal));
}

.btn-secondary {
    background: var(--gray-100);
    color: var(--gray-700);
}

.btn-outline {
    background: transparent;
    border: 2px solid var(--clinical-blue);
    color: var(--clinical-blue);
}

/* ===== PAGE STYLES ===== */
.page {
    max-width: var(--max-width);
    margin: 0 auto;
    padding: 2rem;
    animation: fadeIn 0.3s ease;
}

.page-header {
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--gray-200);
}

.page-header h1 {
    font-size: var(--text-3xl);
    font-weight: 800;
    margin-bottom: 0.5rem;
}

/* ===== PROJECT CARDS ===== */
.projects-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-top: 1.5rem;
}

.project-card {
    background: white;
    border: 1px solid var(--gray-200);
    border-radius: 16px;
    padding: 1.5rem;
    transition: all 0.3s ease;
    cursor: pointer;
}

.project-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    border-color: var(--clinical-blue);
}

.project-title {
    font-size: 1.25rem;
    font-weight: 700;
    margin: 1rem 0;
    color: var(--gray-900);
}

.project-description {
    color: var(--gray-600);
    line-height: 1.6;
    margin-bottom: 1rem;
}

/* ===== BADGES ===== */
.badge {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.badge-clinical {
    background: rgba(26, 86, 219, 0.1);
    color: var(--clinical-blue);
}

.badge-industry {
    background: rgba(14, 159, 110, 0.1);
    color: var(--industry-teal);
}

.badge-collaboration {
    background: rgba(126, 58, 242, 0.1);
    color: var(--accent-purple);
}

.badge-traci {
    background: rgba(59, 130, 246, 0.1);
    color: #3B82F6;
}

/* ===== MODALS ===== */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    padding: 1rem;
    animation: fadeIn 0.2s ease;
}

.modal-overlay:not(.active) {
    display: none;
}

.modal-content {
    background: white;
    border-radius: 16px;
    width: 100%;
    max-width: 800px;
    max-height: 90vh;
    overflow-y: auto;
    animation: slideInUp 0.3s ease;
}

.modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--gray-200);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.modal-header h2 {
    font-size: 1.5rem;
    font-weight: 700;
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--gray-500);
}

.modal-body {
    padding: 1.5rem;
}

/* ===== FORM STYLES ===== */
.form-group {
    margin-bottom: 1.5rem;
}

.form-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--gray-700);
}

.form-group input,
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 2px solid var(--gray-200);
    border-radius: 8px;
    font-family: inherit;
    font-size: 1rem;
    transition: border-color 0.2s;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    outline: none;
    border-color: var(--clinical-blue);
}

/* ===== TOASTS ===== */
.toast-container {
    position: fixed;
    top: 1rem;
    right: 1rem;
    z-index: 3000;
}

.toast {
    background: white;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 0.5rem;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    max-width: 400px;
    animation: slideInRight 0.3s ease;
}

.toast-success {
    border-left: 4px solid var(--success-green);
}

.toast-error {
    border-left: 4px solid var(--error-red);
}

.toast-info {
    border-left: 4px solid var(--clinical-blue);
}

.toast-exit {
    animation: slideOutRight 0.3s ease forwards;
}

@keyframes slideOutRight {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}

/* ===== RESPONSIVE ===== */
@media (max-width: 768px) {
    .page {
        padding: 1rem;
    }
    
    .projects-grid {
        grid-template-columns: 1fr;
    }
    
    .modal-content {
        width: 95vw;
        max-height: 80vh;
    }
}

/* ===== DARK MODE ===== */
@media (prefers-color-scheme: dark) {
    body {
        background: var(--gray-900);
        color: var(--gray-100);
    }
    
    .project-card {
        background: var(--gray-800);
        border-color: var(--gray-700);
    }
    
    .modal-content {
        background: var(--gray-800);
    }
}
`;

// Inject CSS
const style = document.createElement('style');
style.textContent = remainingCSS;
document.head.appendChild(style);
</script>
</body>
</html>
